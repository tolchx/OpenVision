name: Build OpenVision IPA

on:
  workflow_dispatch:
    inputs:
      bundle_id:
        description: 'Bundle Identifier (e.g. com.yourname.openvision)'
        required: false
        default: 'com.openvision.app'

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show available Xcode versions
        run: ls /Applications/ | grep Xcode

      - name: Select latest Xcode
        run: |
          XCODE_APP=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          echo "Using: $XCODE_APP"
          sudo xcode-select -s "$XCODE_APP/Contents/Developer"
          xcodebuild -version

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Create Config.xcconfig
        run: |
          cat > Config.xcconfig << 'XCEOF'
          DEVELOPMENT_TEAM = TEMPORARY
          PRODUCT_BUNDLE_IDENTIFIER = com.openvision.app
          META_APP_ID = 000000000
          CLIENT_TOKEN = AR|000000000|temporary
          APP_LINK_URL_SCHEME = openvision
          XCEOF
          sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = .*/PRODUCT_BUNDLE_IDENTIFIER = ${{ github.event.inputs.bundle_id }}/" Config.xcconfig
          sed -i '' "s/META_APP_ID = .*/META_APP_ID = ${{ secrets.META_APP_ID }}/" Config.xcconfig
          sed -i '' "s|CLIENT_TOKEN = .*|CLIENT_TOKEN = ${{ secrets.CLIENT_TOKEN }}|" Config.xcconfig
          echo "--- Config.xcconfig contents ---"
          cat Config.xcconfig

      - name: Create Config.swift
        run: |
          cat > OpenVision/Config/Config.swift << 'SWIFTEOF'
          import Foundation

          enum Config {
              static let defaultOpenClawGatewayURL = ""
              static let defaultOpenClawAuthToken = ""
              static let defaultGeminiAPIKey = ""
              static let appVersion = Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? "1.0"
              static let buildNumber = Bundle.main.infoDictionary?["CFBundleVersion"] as? String ?? "1"
          }
          SWIFTEOF
          echo "--- Config.swift contents ---"
          cat OpenVision/Config/Config.swift

      - name: Remove old Xcode project (incompatible format v77)
        run: rm -rf OpenVision.xcodeproj

      - name: Generate fresh Xcode project via xcodegen
        run: |
          xcodegen generate
          echo "--- Generated project format ---"
          head -5 OpenVision.xcodeproj/project.pbxproj

      - name: Resolve Swift Package dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -scheme OpenVision \
            -project OpenVision.xcodeproj

      - name: Build for iOS device (unsigned)
        run: |
          xcodebuild build \
            -scheme OpenVision \
            -project OpenVision.xcodeproj \
            -destination 'generic/platform=iOS' \
            -configuration Release \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            DEVELOPMENT_TEAM="" \
            -derivedDataPath ./DerivedData

      - name: Package IPA
        run: |
          mkdir -p Payload
          APP_PATH=$(find ./DerivedData -name "OpenVision.app" -type d | head -1)
          echo "Found app at: $APP_PATH"
          cp -r "$APP_PATH" Payload/
          zip -r OpenVision.ipa Payload/
          echo "IPA size: $(du -h OpenVision.ipa | cut -f1)"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenVision-IPA
          path: OpenVision.ipa
          retention-days: 30
